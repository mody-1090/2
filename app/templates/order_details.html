{% extends "base.html" %}
{% block title %}ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ© - {{ order.name }}{% endblock %}

{% block content %}
<h2 class="mb-4">ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©: <span class="text-primary">{{ order.name }}</span></h2>

<div class="row">
  <div class="col-md-6">
    <div class="card shadow-sm border-0">
      <!-- ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ -->
      <img src="{{ order.image_url if order.image_url else url_for('static', filename='images/default_product.jpg') }}" alt="Product Image">
       
    </div>
  </div>
</div>

  <!-- ğŸ” Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ© -->
  <div class="col-md-6">
    <h4>ğŸ“ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</h4>
    <p>{{ order.description }}</p>

    {% set approved_quantity = order.participants|selectattr("status", "equalto", "approved")|map(attribute="cartons_requested")|sum %}

    <!-- ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ§Øª -->
    <h5>ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: {{ order.quantity_needed }}</h5>
    <h5>âœ… Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: {{ approved_quantity }}</h5>
    
    <!-- ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ -->
    <div class="progress mb-3" style="height: 25px;">
      {% set progress_value = (approved_quantity / order.quantity_needed) * 100 if order.quantity_needed > 0 else 0 %}
      <div class="progress-bar bg-success" role="progressbar"
           style="width: {{ progress_value }}%;"
           aria-valuenow="{{ progress_value }}" aria-valuemin="0" aria-valuemax="100">
        {{ progress_value|round|int }}%
      </div>
    </div>
    
    <!-- ğŸ¯ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙˆØ³ÙŠØ· -->
    <p class="text-success fw-bold">
      ğŸ’° Ù…ÙƒØ³Ø¨ Ø§Ù„ÙˆØ³ÙŠØ· Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:
      <span class="text-dark"> {{ order.earnings_per_carton * 20 * order.min_contribution }} Ø±ÙŠØ§Ù„ </span>
      Ø¹Ù†Ø¯ Ø¥ØªÙ…Ø§Ù… 20 Ø¹Ù…ÙŠÙ„!
    </p>

    <!-- ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© -->
    <h5>ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ ÙƒØ±ØªÙˆÙ†Ø©: {{ order.price_per_carton }} Ø±ÙŠØ§Ù„</h5>
    <h5>ğŸ”¢ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©: {{ order.min_contribution }} ÙƒØ±ØªÙˆÙ†Ø©</h5>
    <h5>ğŸ’° Ù…ÙƒØ³Ø¨ Ø§Ù„ÙˆØ³ÙŠØ· Ù„ÙƒÙ„ ÙƒØ±ØªÙˆÙ†: {{ order.earnings_per_carton }} Ø±ÙŠØ§Ù„</h5>  <!-- âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡ Ù‡Ù†Ø§ -->

    <!-- ğŸ’³ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ… -->
    <h5>ğŸ™ï¸ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©: {{ order.cities_available }}</h5>
    <h5>ğŸ“… Ù…ÙˆØ¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©: {{ order.closing_date.strftime('%Y-%m-%d') }}</h5>
    <h5>ğŸšš Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: {{ order.delivery_date.strftime('%Y-%m-%d') }}</h5>

    {% set approved_quantity = order.participants | selectattr("status", "equalto", "approved") | map(attribute="cartons_requested") | sum %}
    {% set existing_participant = order.participants | selectattr("intermediary_id", "equalto", session["user_id"]) | list %}
    
    {% if approved_quantity < order.quantity_needed and order.intermediary_status == "open" %}
        {% if not existing_participant %}
        <form method="POST" action="{{ url_for('main_routes.join_order', order_id=order.id) }}">
          <button type="submit" class="btn btn-primary btn-lg w-100">
                ğŸ¤ Ø§Ù†Ø¶Ù… ÙƒÙˆØ³ÙŠØ· ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©
              </button>
            </form>
        {% else %}
            <button class="btn btn-secondary btn-lg w-100" disabled>
              âœ… Ø£Ù†Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆØ³ÙŠØ· ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©
            </button>
        {% endif %}
    {% else %}
        <button class="btn btn-secondary btn-lg w-100" disabled>
          ğŸš« Ø§Ù„Ø·Ù„Ø¨ÙŠØ© Ù„Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ÙˆØ³Ø·Ø§Ø¡ Ø¥Ø¶Ø§ÙÙŠÙŠÙ†
        </button>
    {% endif %}
</div>

<hr>


{% endblock %}
