{% extends "base.html" %}
{% block title %}ููุญุฉ ุชุญูู ุงููุณูุท{% endblock %}

{% block content %}
<div class="container-fluid p-4">
  <!-- ุนููุงู ุงูุตูุญุฉ -->
  <div class="row mb-4">
    <div class="col text-center">
      <h2 class="display-5">๐ฏ ููุญุฉ ุชุญูู ุงููุณูุท - {{ user.username }}</h2>
    </div>
  </div>

  <div class="row">
    <!-- ุงูุดุฑูุท ุงูุฌุงูุจู ููุชููู -->
    <div class="col-md-3 mb-4">
      <div class="list-group shadow">
        <!-- ุฅุนุงุฏุฉ ุชุฑุชูุจ ุนูุงุตุฑ ุงููุงุฆูุฉ -->
        <a href="#homeSection" class="list-group-item list-group-item-action active">
          <i class="bi bi-speedometer2"></i> ุงูุฑุฆูุณูุฉ
        </a>
        <a href="#ordersTable" class="list-group-item list-group-item-action">
          <i class="bi bi-card-list"></i> ุงูุทูุจุงุช
        </a>
        <a href="#addOrder" class="list-group-item list-group-item-action">
          <i class="bi bi-plus-circle"></i> ุฅุถุงูุฉ ุทูุจ
        </a>
      </div>
    </div>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <div class="col-md-9">
      <!-- 1. ูุณู ุงูุฑุฆูุณูุฉ -->
      <div class="section" id="homeSection">

        <<!-- ๐ ูุณู ุงูุฅุดุนุงุฑุงุช -->
        <h3>๐ ุงูุฅุดุนุงุฑุงุช</h3>
        <div class="card shadow mb-4">
          <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-bell"></i> ุฅุดุนุงุฑุงุชู</h4>
            <span class="text-muted">๐ ุฃุญุฏุซ 5 ุฅุดุนุงุฑุงุช</span>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>๐ ุงูุชุงุฑูุฎ</th>
                  <th>๐ข ุงูุฅุดุนุงุฑ</th>
                </tr>
              </thead>
              <tbody>
                {% set notifications = user.notifications | sort(attribute='created_at', reverse=True) %}
                {% for notification in notifications[:5] %}
                <tr>
                  <td>{{ notification.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>{{ notification.message }}</td>
                </tr>
                {% endfor %}
                {% if notifications | length == 0 %}
                <tr>
                  <td colspan="2" class="text-center">๐ ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุฌุฏูุฏุฉ.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- ูุณู ุงูุฏุนู ุงูููู -->
        <div class="support-section creative-support">
          <h2>๐น ุงูุฏุนู ุงูููู</h2>
          <p>ุฅุฐุง ููุช ุชูุงุฌู ูุดููุฉุ ููููู ูุชุญ ุชุฐูุฑุฉ ุฏุนู ููู.</p>
          <a href="{{ url_for('main_routes.intermediary_support') }}" class="btn btn-primary creative-btn">ูุชุญ ุชุฐูุฑุฉ ุฏุนู</a>
        </div>

        <table class="table">
          <thead>
              <tr>
                  <th>#</th>
                  <th>ุงุณู ุงูุทูุจ</th>
                  <th>ุญุงูุฉ ุงูุทูุจ</th>
                  <th>ููู ุงูุทูุจูุฉ</th>
              </tr>
          </thead>
          <tbody>
            {% for order, participant in participant_orders %}
                {% if participant.cartons_requested == 0 %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ order.name }}</td>
                    <td>{{ participant.status }}</td>
                    <td>
                        {% if order.zip_file_path %}
                            <a href="{{ order.zip_file_path }}" class="btn btn-primary btn-sm" target="_blank">๐ฅ ุชุญููู ุงูููู</a>
                        {% else %}
                            <span class="text-muted">ูุง ููุฌุฏ ููู</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
          </tbody>
        </table>

        <h3>๐ฐ ููุฎุต ุงูุฃุฑุจุงุญ</h3>
        <div class="row">
          <!-- ุงูุฃุฑุจุงุญ ุงููุญููุฉ -->
          <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
              <div class="card-header">๐ฐ ุงูุฃุฑุจุงุญ ุงููุญููุฉ</div>
              <div class="card-body">
                <h5 class="card-title">{{ total_earnings }} ุฑูุงู</h5>
                <p class="card-text">ูุฐุง ุงููุจูุบ ูุชุงุญ ููุณุญุจ.</p>
              </div>
            </div>
          </div>
          <!-- ุงูุฃุฑุจุงุญ ููุฏ ุงููุฑุงุฌุนุฉ -->
          <div class="col-md-4">
            <div class="card text-white bg-warning mb-3">
              <div class="card-header">โณ ุงูุฃุฑุจุงุญ ููุฏ ุงููุฑุงุฌุนุฉ</div>
              <div class="card-body">
                <h5 class="card-title">{{ pending_earnings }} ุฑูุงู</h5>
                <p class="card-text">ูุฐุง ุงููุจูุบ ููุฏ ุงููุฑุงุฌุนุฉ ูุจู ุงูุชุญููู.</p>
              </div>
            </div>
          </div>
          <!-- ุงูุฃุฑุจุงุญ ุงููุณุญูุจุฉ -->
          <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
              <div class="card-header">โ ุงูุฃุฑุจุงุญ ุงููุณุญูุจุฉ</div>
              <div class="card-body">
                <h5 class="card-title">{{ withdrawn_earnings }} ุฑูุงู</h5>
                <p class="card-text">ุชู ุชุญููู ูุฐุง ุงููุจูุบ ุฅููู.</p>
              </div>
            </div>
          </div>
        </div>

        <h3>๐ฐ ูุชุงุจุนุฉ ุญุงูุฉ ุทูุจุงุช ุงูุณุญุจ</h3>
        <div class="card shadow mb-4">
          <div class="card-header bg-info text-white">
            <h4 class="mb-0"><i class="bi bi-clock-history"></i> ุทูุจุงุช ุงูุณุญุจ</h4>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>๐ ุชุงุฑูุฎ ุงูุทูุจ</th>
                  <th>๐ฐ ุงููุจูุบ</th>
                  <th>๐ฆ ุงูุจูู</th>
                  <th>๐ณ ุฑูู ุงูุญุณุงุจ</th>
                  <th>๐ข ุงูุขูุจุงู</th>
                  <th>โ ุงูุญุงูุฉ</th>
                </tr>
              </thead>
              <tbody>
                {% for request in withdrawal_requests %}
                <tr>
                  <td>{{ request.created_at.strftime('%Y-%m-%d') }}</td>
                  <td>{{ request.amount }} ุฑูุงู</td>
                  <td>{{ request.bank_name }}</td>
                  <td>{{ request.account_number }}</td>
                  <td>{{ request.iban_number }}</td>
                  <td>
                    {% if request.status == "pending" %}
                      <span class="badge bg-warning">โณ ููุฏ ุงููุฑุงุฌุนุฉ</span>
                    {% elif request.status == "approved" %}
                      <span class="badge bg-success">โ ููุจูู</span>
                    {% else %}
                      <span class="badge bg-danger">โ ูุฑููุถ</span>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="6" class="text-center">ูุง ุชูุฌุฏ ุทูุจุงุช ุณุญุจ ุญุชู ุงูุขู.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#withdrawModal">
          ๐ฐ ุทูุจ ุณุญุจ ุงูุฃุฑุจุงุญ
        </button>

        <!-- ูุงูุฐุฉ ุชูุฏูู ุทูุจ ุณุญุจ ุงูุฃุฑุจุงุญ -->
        <div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="withdrawModalLabel">ุทูุจ ุณุญุจ ุงูุฃุฑุจุงุญ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ุฅุบูุงู"></button>
              </div>
              <div class="modal-body">
                <form method="POST" action="{{ url_for('main_routes.request_withdrawal') }}">
                  {{ form.hidden_tag() }}
                  <!-- ๐น ุงุณู ุตุงุญุจ ุงูุญุณุงุจ ุงูุจููู -->
                  <div class="mb-3">
                    <label class="form-label">๐ค ุงุณู ุตุงุญุจ ุงูุญุณุงุจ</label>
                    {{ form.account_holder(class="form-control", placeholder="ุฃุฏุฎู ุงุณู ุตุงุญุจ ุงูุญุณุงุจ") }}
                  </div>

                  <!-- ๐น ุงุณู ุงูุจูู -->
                  <div class="mb-3">
                    <label class="form-label">๐ฆ ุงุณู ุงูุจูู</label>
                    {{ form.bank_name(class="form-control", placeholder="ุฃุฏุฎู ุงุณู ุงูุจูู") }}
                  </div>

                  <!-- ๐น ุฑูู ุงูุญุณุงุจ ุงูุจููู -->
                  <div class="mb-3">
                    <label class="form-label">๐ณ ุฑูู ุงูุญุณุงุจ ุงูุจููู</label>
                    {{ form.account_number(class="form-control", placeholder="ุฃุฏุฎู ุฑูู ุงูุญุณุงุจ") }}
                  </div>

                  <!-- ๐น ุฑูู ุงูุขูุจุงู -->
                  <div class="mb-3">
                    <label class="form-label">๐ข ุฑูู ุงูุขูุจุงู</label>
                    {{ form.iban_number(class="form-control", placeholder="ุฃุฏุฎู ุฑูู ุงูุขูุจุงู") }}
                  </div>

                  <!-- ๐น ุงููุจูุบ ุงููุทููุจ (ูุง ูููู ุชุนุฏูููุ ูุนุชูุฏ ุนูู ุงูุฃุฑุจุงุญ ุงููุญููุฉ) -->
                  <div class="mb-3">
                    <label class="form-label">๐ฐ ุงููุจูุบ ุงููุทููุจ ุณุญุจู</label>
                    <input type="number" class="form-control" name="amount" value="{{ total_earnings }}" readonly>
                  </div>

                  <!-- ุฒุฑ ุชูุฏูู ุงูุทูุจ -->
                  {{ form.submit(class="btn btn-success w-100") }}
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <hr>

      <!-- 2. ูุณู ุงูุทูุจุงุช ุงููุณุฌูุฉ -->
      <div class="section" id="ordersTable">
        <h3>๐ ุงูุทูุจุงุช ุงููุณุฌูุฉ</h3>

        <!-- ๐ ุฒุฑ ุชุญุฏูุซ ุงูุตูุญุฉ -->
        <div class="text-end mb-3">
          <button class="btn btn-info" onclick="location.reload();">
            <i class="bi bi-arrow-clockwise"></i> ุชุญุฏูุซ ุงูุตูุญุฉ
          </button>
        </div>

        <!-- ุงูุทูุจุงุช ููุฏ ุงููุฑุงุฌุนุฉ -->
        <div class="card shadow mb-4">
          <div class="card-header bg-warning text-dark">
            <h4 class="mb-0"><i class="bi bi-hourglass-split"></i> ุงูุทูุจุงุช ููุฏ ุงููุฑุงุฌุนุฉ</h4>
          </div>
          <div class="card-body table-responsive">
            {% set per_page = 5 %}
            {% set review_participants = managed_participants | selectattr("status", "equalto", "under_review") | selectattr("cartons_requested", "gt", 0) | list %}
            {% set total_review_pages = (review_participants|length // per_page) + (1 if review_participants|length % per_page > 0 else 0) %}
            <div id="review-pages">
              {% for page in range(total_review_pages) %}
                <div class="page review-page" id="review-page-{{ page }}" {% if page > 0 %}style="display: none;"{% endif %}>
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>๐ฆ ุงูุทูุจูุฉ</th>
                        <th>๐ช ุงููุชุฌุฑ</th>
                        <th>๐ฆ ุนุฏุฏ ุงููุฑุงุชูู</th>
                        <th>๐ ุงููููุน</th>
                        <th>๐ค ุงููุณุคูู</th>
                        <th>๐ฑ ุฑูู ุงูุฌูุงู</th>
                        <th>๐ ุงูุชูุงุตูู</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for participant in review_participants[page * per_page : (page + 1) * per_page] %}
                      <tr>
                        <td>{{ participant.order.name }}</td>
                        <td>{{ participant.store_name }}</td>
                        <td>{{ participant.cartons_requested }}</td>
                        <td>{{ participant.location }}</td>
                        <td>{{ participant.responsible_person }}</td>
                        <td>{{ participant.customer_phone }}</td>
                        <td>
                          <a href="{{ url_for('main_routes.customer_order_details', participant_id=participant.id) }}" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye"></i> ุนุฑุถ
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endfor %}
            </div>
            <div class="text-center mt-3">
              {% if total_review_pages > 1 %}
                <button class="btn btn-warning btn-sm" onclick="changePage('review', -1)">โฌ๏ธ ุงูุณุงุจู</button>
                <span id="review-page-indicator">ุตูุญุฉ 1 ูู {{ total_review_pages }}</span>
                <button class="btn btn-warning btn-sm" onclick="changePage('review', 1)">ุงูุชุงูู โก๏ธ</button>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- ุงูุทูุจุงุช ุงูููุจููุฉ -->
        <div class="card shadow mb-4">
          <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="bi bi-check-circle"></i> ุงูุทูุจุงุช ุงูููุจููุฉ</h4>
          </div>
          <div class="card-body table-responsive">
            {% set approved_participants = managed_participants | selectattr("status", "equalto", "approved") | selectattr("cartons_requested", "gt", 0) | list %}
            {% set total_approved_pages = (approved_participants|length // per_page) + (1 if approved_participants|length % per_page > 0 else 0) %}
            <div id="approved-pages">
              {% for page in range(total_approved_pages) %}
                <div class="page approved-page" id="approved-page-{{ page }}" {% if page > 0 %}style="display: none;"{% endif %}>
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>๐ฆ ุงูุทูุจูุฉ</th>
                        <th>๐ช ุงููุชุฌุฑ</th>
                        <th>๐ฆ ุนุฏุฏ ุงููุฑุงุชูู</th>
                        <th>๐ ุงููููุน</th>
                        <th>๐ค ุงููุณุคูู</th>
                        <th>๐ฑ ุฑูู ุงูุฌูุงู</th>
                        <th>๐ ุงูุชูุงุตูู</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for participant in approved_participants[page * per_page : (page + 1) * per_page] %}
                      <tr>
                        <td>{{ participant.order.name }}</td>
                        <td>{{ participant.store_name }}</td>
                        <td>{{ participant.cartons_requested }}</td>
                        <td>{{ participant.location }}</td>
                        <td>{{ participant.responsible_person }}</td>
                        <td>{{ participant.customer_phone }}</td>
                        <td>
                          <a href="{{ url_for('main_routes.customer_order_details', participant_id=participant.id) }}" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye"></i> ุนุฑุถ
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endfor %}
            </div>
            <div class="text-center mt-3">
              {% if total_approved_pages > 1 %}
                <button class="btn btn-success btn-sm" onclick="changePage('approved', -1)">โฌ๏ธ ุงูุณุงุจู</button>
                <span id="approved-page-indicator">ุตูุญุฉ 1 ูู {{ total_approved_pages }}</span>
                <button class="btn btn-success btn-sm" onclick="changePage('approved', 1)">ุงูุชุงูู โก๏ธ</button>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- ุงูุทูุจุงุช ุงููุฑููุถุฉ -->
        <div class="card shadow mb-4">
          <div class="card-header bg-danger text-white">
            <h4 class="mb-0"><i class="bi bi-x-circle"></i> ุงูุทูุจุงุช ุงููุฑููุถุฉ</h4>
          </div>
          <div class="card-body table-responsive">
            {% set rejected_participants = managed_participants | selectattr("status", "equalto", "rejected") | list %}
            {% set total_rejected_pages = (rejected_participants|length // per_page) + (1 if rejected_participants|length % per_page > 0 else 0) %}
            <div id="rejected-pages">
              {% for page in range(total_rejected_pages) %}
                <div class="page rejected-page" id="rejected-page-{{ page }}" {% if page > 0 %}style="display: none;"{% endif %}>
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>๐ฆ ุงูุทูุจูุฉ</th>
                        <th>๐ช ุงููุชุฌุฑ</th>
                        <th>๐ ุงููููุน</th>
                        <th>๐ค ุงููุณุคูู</th>
                        <th>๐ฑ ุฑูู ุงูุฌูุงู</th>
                        <th>๐ ุงูุชูุงุตูู</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for participant in rejected_participants[page * per_page : (page + 1) * per_page] %}
                      <tr>
                        <td>{{ participant.order.name }}</td>
                        <td>{{ participant.store_name }}</td>
                        <td>{{ participant.location }}</td>
                        <td>{{ participant.responsible_person }}</td>
                        <td>{{ participant.customer_phone }}</td>
                        <td>
                          <a href="{{ url_for('main_routes.customer_order_details', participant_id=participant.id) }}" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye"></i> ุนุฑุถ
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endfor %}
            </div>
            <div class="text-center mt-3">
              {% if total_rejected_pages > 1 %}
                <button class="btn btn-danger btn-sm" onclick="changePage('rejected', -1)">โฌ๏ธ ุงูุณุงุจู</button>
                <span id="rejected-page-indicator">ุตูุญุฉ 1 ูู {{ total_rejected_pages }}</span>
                <button class="btn btn-danger btn-sm" onclick="changePage('rejected', 1)">ุงูุชุงูู โก๏ธ</button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <hr>

      <!-- 3. ูุณู ุชุณุฌูู ุทูุจ ุฌุฏูุฏ -->
      <div class="section" id="addOrder">
        <!-- ุดุฑุญ ุขููุฉ ุงูุจูุน ุงููุจุงุดุฑ -->
        <div class="alert alert-info">
          <h3>๐น ุขููุฉ ุงูุจูุน ุงููุจุงุดุฑ - ููู ุชุตุจุญ ุชุงุฌุฑ ุฌููุฉุ</h3>
          <p>
            ุจุนุฏ ุงูุถูุงูู ุฅูู ุงูุทูุจูุฉุ ุฃุตุจุญุช ุงูุขู ุชุงุฌุฑ ุฌููุฉ ุฑุณูููุง! ๐ ููุฐุง ูุนูู ุฃูู ุชุณุชุทูุน ุจูุน ุงูููุชุฌุงุช ูุจุงุดุฑุฉู ูุนููุงุฆู ุจุณูููุฉุ ุฏูู ุงูุญุงุฌุฉ ุฅูู ุฑุฃุณ ูุงู ูุณุจู ุฃู ูุฎุฒูู.
          </p>
          <h4>๐ผ ููู ูุนูู ุงูุจูุน ุงููุจุงุดุฑุ</h4>
          <ul>
            <li><strong>ุงูุถู ุฅูู ุงูุทูุจูุฉ:</strong> ุจูุฌุฑุฏ ุงูุถูุงููุ ุณุชุญุตู ุนูู ุฑูุงุจุท ุชุณุฌูู ูุฎุตุตุฉ ูุนููุงุฆู.</li>
            <li><strong>ุดุงุฑู ุฑูุงุจุท ุงูุชุณุฌูู:</strong> ูู ุจูุดุงุฑูุฉ ุงูุฑุงุจุท ูุน ุนููุงุฆู ุนุจุฑ ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนูุ ุงููุงุชุณุงุจุ ุฃู ุฃู ูุณููุฉ ุชูุถููุง.</li>
            <li><strong>ุงูุนููุงุก ูุณุฌููู ุนุจุฑ ุฑุงุจุทู:</strong> ุจูุฌุฑุฏ ุชุณุฌูู ุงูุนููุงุก ูู ุฎูุงู ุงูุฑุงุจุท ุงูุฎุงุต ุจูุ ูุชู ุฑุจุทูู ุจู ูุจุงุดุฑุฉ ุฏุงุฎู ุงููุธุงู.</li>
            <li><strong>ุงุณุชูุงู ุงูุทูุจุงุช ููุณุจ ุงูุฃุฑุจุงุญ:</strong> ูููู ูุนููุงุฆู ุชูุฏูู ุงูุทูุจุงุช ูุจุงุดุฑุฉุ ูุณุชุญุตู ุนูู ุฃุฑุจุงุญู ุจุณูููุฉ ุนูุฏ ูุจูู ุงูุทูุจูุฉ.</li>
          </ul>
          <p>
            ๐ <strong>ุจูุฐู ุงูุทุฑููุฉุ ุฃูุช ุงูุขู ุชุงุฌุฑ ุฌููุฉ ูุนุงู! ููููู ุจูุงุก ูุงุนุฏุฉ ุนููุงุฆู ูุชุญููู ุงูุฃุฑุจุงุญ ุจุฏูู ุงูุญุงุฌุฉ ุฅูู ุดุฑุงุก ุงูููุชุฌุงุช ูุณุจููุง.</strong>
          </p>
          <p>
            ๐ <strong>ุงูุณุฎ ุฑุงุจุท ุงูุชุณุฌูู ุงููุฎุตุต ููู ุทูุจูุฉ ูุงุจุฏุฃ ุงูุจูุน ุงูุขู!</strong>
          </p>
          
          <!-- ุดุฑุญ ูุง ูุญุตู ุนููู ุนููุงุคู ุจุนุฏ ุงูุชุณุฌูู -->
          <div class="alert alert-success">
            <h3>๐ ูุงุฐุง ูุญุตู ุนููู ุนููุงุคู ุจุนุฏ ุงูุชุณุฌููุ</h3>
            <p>
              ุจูุฌุฑุฏ ุฃู ูููู ุนููุงุคู ุจุงูุชุณุฌูู ุนุจุฑ ุงูุฑุงุจุท ุงูุฎุงุต ุจู ูุฅุชูุงู ุทูุจุงุชููุ ุณูุชููููู ูู ุงูุญุตูู ุนูู ุงููุณุชูุฏุงุช ุงูุชุงููุฉ ุญุณุจ ุญุงูุฉ ุงูุทูุจ:
            </p>
            <ul>
              <li>๐ฆ <strong>ุณูุฏ ุงุณุชูุงู ุงูุทูุจูุฉ:</strong> ูุชู ุฅุตุฏุงุฑู ุนูุฏ ุชูุฏูู ุงูุนููู ูุทูุจู ููุจููู ูุจุฏุฆููุงุ ููุง ููุถุญ ุฃู ุงูุทูุจ ููุฏ ุงููุฑุงุฌุนุฉ ููู ูุชู ุชุฃููุฏู ุจุนุฏ.</li>
              <li>๐ฐ <strong>ุณูุฏ ุงุณุชูุงู ุงููุจูุบ:</strong> ููุตุฏุฑ ุนูุฏ ุฅุชูุงู ุนูููุฉ ุงูุฏูุน ูุงูููุงููุฉ ุนูู ุงูุทูุจูุฉ ุฑุณูููุงุ ููุง ูุคูุฏ ุฏุฎูู ุงูุทูุจ ุญูุฒ ุงูุชูููุฐ.</li>
              <li>๐ <strong>ุณูุฏ ุงูุงุณุชุฑุฌุงุน:</strong> ูุชู ุฅุตุฏุงุฑู ูู ุญุงู ุฅูุบุงุก ุงูุทูุจ ุฃู ุงุณุชุฑุฌุงุนูุ ููู ุชุฃููุฏ ูุนูููุฉ ุงูุงุณุชุฑุฌุงุน ุฃู ุฑูุถ ุงูุทูุจูุฉ.</li>
            </ul>
            <p>
              ๐ ูููู ููุนููุงุก ุงููุตูู ุฅูู ูุฐู ุงููุณุชูุฏุงุช ุจุณูููุฉ ุนุจุฑ ุงููุธุงูุ ููุง ูุถูู ุงูุดูุงููุฉ ูุงูุซูุฉ ูู ุนูููุงุช ุงูุจูุน ูุงูุดุฑุงุก.
            </p>
          </div>
        </div>

        <!-- ุฎูุงุฑุงุช ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุชุณุฌูู -->
        <div class="mb-3">
          <label class="form-label">ุงุฎุชุฑ ุทุฑููุฉ ุงูุชุณุฌูู:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="registration_mode" id="manualRegistration" value="manual" checked>
            <label class="form-check-label" for="manualRegistration">ุชุณุฌูู ุงูุนููู ูุฏูู</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="registration_mode" id="selfRegistration" value="self">
            <label class="form-check-label" for="selfRegistration">ุงูุนููู ูุณุฌู ููุณู ุนู ุทุฑูู ุงูุฑุงุจุท</label>
          </div>
        </div>

        <!-- ุชุบููู ุงููููุฐุฌ ุงูุญุงูู ุฏุงุฎู ูุณู ุงูุชุณุฌูู ุงููุฏูู -->
        <div id="manualRegistrationSection">
          <h3>โ ุชุณุฌูู ุทูุจ ุฌุฏูุฏ</h3>
          <div class="card mb-4 shadow">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0"><i class="bi bi-pencil-square"></i> ุชุณุฌูู ุทูุจ ุฌุฏูุฏ</h4>
            </div>
            <div class="card-body">
              <form method="POST" action="{{ url_for('main_routes.add_customer') }}" enctype="multipart/form-data">
                <!-- ๐น ุงุฎุชูุงุฑ ุงูุทูุจูุฉ -->
                <div class="mb-3">
                  <label class="form-label">๐ท๏ธ ุงุฎุชุฑ ุงูุทูุจูุฉ</label>
                  <select class="form-select" name="order_id" id="order_id" required>
                    <option value="" selected disabled>-- ุงุฎุชุฑ ุงูุทูุจูุฉ --</option>
                    {% for order in assigned_orders %}
                      <option value="{{ order.id }}" 
                              data-price="{{ order.price_per_carton }}" 
                              data-min="{{ order.min_contribution }}" 
                              data-bank-name="{{ order.factory_agreement.bank_name if order.factory_agreement else '' }}"
                              data-bank-account="{{ order.factory_agreement.bank_account_number if order.factory_agreement else '' }}"
                              data-iban="{{ order.factory_agreement.iban_number if order.factory_agreement else '' }}"
                              data-commercial-registration="{{ order.factory_agreement.commercial_registration if order.factory_agreement else '' }}">
                        {{ order.name }} (ุงูุญุฏ ุงูุฃุฏูู: {{ order.min_contribution }} ูุฑุชููุ ุงูุณุนุฑ: {{ order.price_per_carton }} ุฑูุงู)
                      </option>
                    {% endfor %}
                  </select>
                </div>

                <!-- ุจุงูู ูููุฐุฌ ุชุณุฌูู ุงูุทูุจ ููุง ูู -->
                <div class="mb-3">
                  <label class="form-label">๐ช ุงุณู ุงููุชุฌุฑ ุฃู ุงูุนููู</label>
                  <input type="text" class="form-control" name="store_name" placeholder="ุฃุฏุฎู ุงุณู ุงููุชุฌุฑ ุฃู ุงูุนููู" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">๐ฆ ุนุฏุฏ ุงููุฑุงุชูู ุงููุทููุจุฉ</label>
                  <input type="number" class="form-control" name="cartons_requested" id="cartons_requested" min="1" required>
                  <small class="text-muted">ูุฌุจ ุฃู ูููู ุงูุนุฏุฏ ุนูู ุงูุฃูู ุงูุญุฏ ุงูุฃุฏูู ุงููุทููุจ.</small>
                </div>

                <div class="mb-3">
                  <label class="form-label">๐ ูููุน ุงูุนููู</label>
                  <input type="text" class="form-control" name="location" placeholder="ุฃุฏุฎู ูููุน ุงูุนููู" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">๐ค ุงุณู ุงููุณุคูู</label>
                  <input type="text" class="form-control" name="responsible_person" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุคูู" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">๐ฑ ุฑูู ุฌูุงู ุงูุนููู</label>
                  <input type="text" class="form-control" name="customer_phone" placeholder="ุฃุฏุฎู ุฑูู ุฌูุงู ุงูุนููู" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">๐ข ุงูุฑูู ุงูุถุฑูุจู</label>
                  <input type="text" class="form-control" name="tax_number" placeholder="ุฃุฏุฎู ุงูุฑูู ุงูุถุฑูุจู" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">๐ ุตูุฑุฉ ุงูุณุฌู ุงูุชุฌุงุฑู</label>
                  <input type="file" class="form-control" name="commercial_record" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">๐ช ุตูุฑุฉ ููุญุฉ ุงููุญู</label>
                  <input type="file" class="form-control" name="store_sign" required>
                </div>

                <!-- ๐น ุชูุงุตูู ุงูุญุณุงุจ ุงูุจููู -->
                <div class="card mb-3 p-3 border">
                  <h5>๐ฆ ุชูุงุตูู ุงูุญุณุงุจ ุงูุจููู</h5>
                  <p>ุนูุฏ ุชุณุฌูู ุงูุทูุจุ ูุฌุจ ุนููู ุงูุฏูุน ูุจุงุดุฑุฉ ุฅูู ุงูููุฑุฏ.</p>
                  <p><strong>๐ฐ ุงููุจูุบ ุงููุทููุจ:</strong> <span id="payment_amount">0</span> ุฑูุงู</p>
                  <p><strong>๐ฆ ุงุณู ุงูุจูู:</strong> <span id="bank_name">ุงูุฑุงุฌุญู / ุดุฑูุฉ ูุญูุฏ ุญุณู ูุญูุฏ ุงูุญุฑุจู ูุชุฌุงุฑุฉ ุงูุฌููุฉ ูุงูุชุฌุฒุฆุฉ</span></p>
                  <p><strong>๐ณ ุฑูู ุงูุญุณุงุจ:</strong> <span id="bank_account">--</span></p>
                  <p><strong>๐ข ุฑูู ุงูุขูุจุงู:</strong> <span id="iban_number">SA9480000589608016204363</span></p>
                  <p><strong>๐ ุงูุณุฌู ุงูุชุฌุงุฑู:</strong> <span id="commercial_registration">--</span></p>
                </div>

                <!-- ๐น ุฑูุน ุฅูุตุงู ุงูุฏูุน -->
                <div class="mb-3">
                  <label class="form-label">๐ค ุฑูุน ุฅูุตุงู ุงูุฏูุน</label>
                  <input type="file" class="form-control" name="payment_receipt" required>
                </div>

                <div class="d-flex justify-content-end gap-2">
                  <button type="reset" class="btn btn-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> ุฅุนุงุฏุฉ ุชุนููู
                  </button>
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> ุชุณุฌูู ุงูุนููู
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- ูุณู ุฑูุงุจุท ุงูุชุณุฌูู ุงูุฐุงุชู -->
        <div id="selfRegistrationSection" style="display: none;">
          <h3>๐ ุฑูุงุจุท ุชุณุฌูู ุงูุนููุงุก ููู ุทูุจูุฉ</h3>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>๐ฆ ุงุณู ุงูุทูุจูุฉ</th>
                <th>๐ ุฑุงุจุท ุงูุชุณุฌูู</th>
              </tr>
            </thead>
            <tbody>
              {% for order in assigned_orders %}
              <tr>
                <td>{{ order.name }}</td>
                <td>
                  <input type="text" class="form-control" value="{{ url_for('main_routes.customer_registration', intermediary_id=user.id, order_id=order.id, _external=True) }}" readonly>
                  <button class="btn btn-sm btn-primary mt-2" onclick="copyToClipboard(this)">๐ ูุณุฎ ุงูุฑุงุจุท</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- ููุงูุฐ ููุตูุต ุงูุฌุงูุง ุณูุฑูุจุช ุชุจูู ุฏูู ุชุบููุฑ -->
      <script>
      // ุฏุงูุฉ ุงููุณุฎ
      function copyToClipboard(button) {
          var input = button.previousElementSibling;
          input.select();
          input.setSelectionRange(0, 99999);
          document.execCommand("copy");
          button.innerText = "โ ุชู ุงููุณุฎ";
          setTimeout(() => {
              button.innerText = "๐ ูุณุฎ ุงูุฑุงุจุท";
          }, 2000);
      }

      // ุนูุฏ ุชุญููู ุงูุตูุญุฉ ูุชู ุฅุธูุงุฑ ุงููุณู ุงูููุงุณุจ
      document.addEventListener("DOMContentLoaded", function() {
          const sections = document.querySelectorAll(".section");
          function showSection(sectionId) {
              sections.forEach(section => {
                  section.style.display = section.id === sectionId ? "block" : "none";
              });
          }

          // ุงูุชุญูู ูู ูุฌูุฏ ูุงุด ูู URL ูุฅุธูุงุฑูุ ูุฅุฐุง ูู ููุฌุฏ ูุชู ุฅุธูุงุฑ "homeSection"
          let hash = window.location.hash.substring(1);
          if (hash && document.getElementById(hash)) {
              showSection(hash);
          } else {
              showSection("homeSection");
          }

          // ุฅุถุงูุฉ ุญุฏุซ ุงูููุฑ ุนูู ุฑูุงุจุท ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ูุชุจุฏูู ุงูุฃูุณุงู
          const navLinks = document.querySelectorAll(".list-group-item[href^='#']");
          navLinks.forEach(link => {
              link.addEventListener("click", function(e) {
                  e.preventDefault();
                  const targetId = this.getAttribute("href").substring(1);
                  showSection(targetId);
                  history.pushState(null, "", "#" + targetId);
                  navLinks.forEach(nav => nav.classList.remove("active"));
                  this.classList.add("active");
              });
          });
      });
      </script>

      <script>
      document.getElementById("order_id").addEventListener("change", function() {
          let selectedOption = this.options[this.selectedIndex];
          let pricePerCarton = parseFloat(selectedOption.getAttribute("data-price"));
          let minContribution = parseInt(selectedOption.getAttribute("data-min"));

          let cartonsInput = document.getElementById("cartons_requested");
          cartonsInput.setAttribute("min", minContribution);
          cartonsInput.value = minContribution;

          let totalAmount = pricePerCarton * minContribution;
          document.getElementById("payment_amount").textContent = totalAmount.toFixed(2);

          let bankName = selectedOption.getAttribute("data-bank-name") || "--";
          let bankAccount = selectedOption.getAttribute("data-bank-account") || "--";
          let ibanNumber = selectedOption.getAttribute("data-iban") || "--";
          let commercialRegistration = selectedOption.getAttribute("data-commercial-registration") || "--";

          document.getElementById("bank_name").textContent = bankName;
          document.getElementById("bank_account").textContent = bankAccount;
          document.getElementById("iban_number").textContent = ibanNumber;
          document.getElementById("commercial_registration").textContent = commercialRegistration;
      });

      document.getElementById("cartons_requested").addEventListener("input", function() {
          let selectedOption = document.getElementById("order_id").options[document.getElementById("order_id").selectedIndex];
          let pricePerCarton = parseFloat(selectedOption.getAttribute("data-price"));

          let cartonsRequested = parseInt(this.value);
          if (isNaN(cartonsRequested) || cartonsRequested < parseInt(selectedOption.getAttribute("data-min"))) {
              cartonsRequested = parseInt(selectedOption.getAttribute("data-min"));
              this.value = cartonsRequested;
          }

          let totalAmount = pricePerCarton * cartonsRequested;
          document.getElementById("payment_amount").textContent = totalAmount.toFixed(2);
      });
      </script>
      <script>
        document.querySelectorAll('input[name="registration_mode"]').forEach((elem) => {
          elem.addEventListener("change", function() {
            if(this.value === "manual") {
              document.getElementById("manualRegistrationSection").style.display = "block";
              document.getElementById("selfRegistrationSection").style.display = "none";
            } else if(this.value === "self") {
              document.getElementById("manualRegistrationSection").style.display = "none";
              document.getElementById("selfRegistrationSection").style.display = "block";
            }
          });
        });
      </script>
      <script>
        function changePage(section, direction) {
          let currentPageElement = document.getElementById(`${section}-page-indicator`);
          let currentPage = parseInt(currentPageElement.textContent.split(" ")[1]);
          let totalPages = parseInt(currentPageElement.textContent.split(" ")[3]);
        
          let newPage = currentPage + direction;
          if (newPage < 1 || newPage > totalPages) return;
        
          document.getElementById(`${section}-page-${currentPage - 1}`).style.display = "none";
          document.getElementById(`${section}-page-${newPage - 1}`).style.display = "block";
          currentPageElement.textContent = `ุตูุญุฉ ${newPage} ูู ${totalPages}`;
        }
      </script>
      




      <script>
        document.getElementById("myForm").addEventListener("submit", function(e) {
          e.preventDefault(); // ููุน ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ
          let formData = new FormData(this);
          fetch(this.action, {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            // ุชุญุฏูุซ ุนูุงุตุฑ ุงูุตูุญุฉ ุจูุงุกู ุนูู ุจูุงูุงุช ุงูุงุณุชุฌุงุจุฉ
            console.log(data);
          })
          .catch(error => console.error('Error:', error));
        });
      </script>
    </div>
  </div>
</div>
{% endblock %}
