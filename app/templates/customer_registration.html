{% extends "base.html" %}

{% block title %}ğŸ“¦ ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©{% endblock %}

{% block content %}
<div class="container p-4">

  <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© -->
  <div class="row mb-4">
    <div class="col text-center">
      <h2 class="display-4">
        <i class="bi bi-person-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
      </h2>
      <p class="lead text-muted">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ØªØ¬Ø±Ùƒ ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ù…ÙˆØ±Ø¯ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©.</p>
    </div>
  </div>

  {% if order %}
  <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ -->
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="bi bi-pencil-square"></i> Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h4>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('main_routes.customer_registration', intermediary_id=intermediary.id, order_id=order.id) }}" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ -->
        <div class="mb-3">
          <label class="form-label">ğŸ·ï¸ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</label>
          <input type="text" class="form-control" value="{{ order.name }} ({{ order.quantity_needed }} ÙƒØ±ØªÙˆÙ†Ø© Ù…ØªØ§Ø­Ø©)" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸª Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input type="text" class="form-control" name="store_name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±Ø§ØªÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
          <input type="number" class="form-control" name="cartons_requested" id="cartons_requested" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±Ø§ØªÙŠÙ†" min="{{ order.min_contribution }}" required>
          <small class="text-muted">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·Ù„Ø¨: {{ order.min_contribution }} ÙƒØ±ØªÙˆÙ†</small>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input type="text" class="form-control" name="location" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±</label>
          <input type="text" class="form-control" name="responsible_person" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" required>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸ“± Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input type="text" class="form-control" name="customer_phone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„" required>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸ”¢ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
          <input type="text" class="form-control" name="tax_number" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ" required>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸ“œ ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
          <input type="file" class="form-control" name="commercial_record" required>
        </div>

        <div class="mb-3">
          <label class="form-label">ğŸª ØµÙˆØ±Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ù„</label>
          <input type="file" class="form-control" name="store_sign" required>
        </div>


        
        {% if order.features %}
        <div class="mb-3">
          <label for="distribution_type" class="form-label">Ø·Ø±ÙŠÙ‚Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <select class="form-control" id="distribution_type" name="distribution_type" required>
            <option value="equal">ØªÙˆØ²ÙŠØ¹ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ</option>
            <option value="custom">ØªÙˆØ²ÙŠØ¹ Ù…Ø®ØµØµ</option>
          </select>
        </div>
      
        <div id="feature-quantity-section" style="display:none;">
          <h5>Ø­Ø¯Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„ÙƒÙ„ Ù…ÙŠØ²Ø©:</h5>
          {% for feature in order.features %}
            <div class="mb-3">
              <label class="form-label">{{ feature.name }}</label>
              <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØ±Ø¯ -->
              <input type="number" class="form-control feature-quantity" data-feature-id="{{ feature.id }}" name="feature_quantities[{{ feature.id }}]" min="0" value="0">
            </div>
          {% endfor %}
        </div>
      
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            let featureSection = document.getElementById("feature-quantity-section");
            let distributionType = document.getElementById("distribution_type");
      
            distributionType.addEventListener("change", function () {
              featureSection.style.display = this.value === "custom" ? "block" : "none";
            });
      
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† "ØªÙˆØ²ÙŠØ¹ Ù…Ø®ØµØµ" Ù…Ø®ØªØ§Ø± Ù…Ø³Ø¨Ù‚Ù‹Ø§
            if (distributionType.value === "custom") {
              featureSection.style.display = "block";
            }
          });
        </script>
      {% endif %}
      
        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ -->
        <h5>ğŸ’µ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h5>
        <p><strong>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬:</strong> {{ order.name }}</p>
        <p><strong>ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±Ø§ØªÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong> <span id="cartons_requested_display">{{ order.min_contribution }}</span></p>
        <p><strong>ğŸ’° Ø³Ø¹Ø± Ø§Ù„ÙƒØ±ØªÙˆÙ† Ø§Ù„ÙˆØ§Ø­Ø¯ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©):</strong> {{ order.price_per_carton }} Ø±ÙŠØ§Ù„</p>

        {% set total_amount = order.price_per_carton * order.min_contribution %}
        <h5 class="text-danger"><strong>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ÙˆÙŠÙ„Ù‡:</strong> <span id="final_payment_amount">{{ total_amount|round(2) }}</span> Ø±ÙŠØ§Ù„</h5>

        <div class="alert alert-info mt-3">
          ğŸ“Œ <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù‡Ø°Ø§ Ù‡Ùˆ **Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­ÙˆÙŠÙ„Ù‡** Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ±Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¶Ù…Ø§Ù† ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ.
        </div>

        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯ -->
        <div class="card mb-3 p-3 border">
          <h5>ğŸ¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ù„Ù„Ù…ÙˆØ±Ø¯</h5>
          <p><strong>ğŸ¦ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ:</strong> {{ order.factory_agreement.bank_name if order.factory_agreement else '--' }}</p>
          <p><strong>ğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨:</strong> {{ order.factory_agreement.bank_account_number if order.factory_agreement else '--' }}</p>
          <p><strong>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†:</strong> {{ order.factory_agreement.iban_number if order.factory_agreement else '--' }}</p>
          <div class="mb-3">
            <label class="form-label">ğŸ“¤ Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹</label>
            <input type="file" class="form-control" name="payment_receipt" required>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2">
          <button type="reset" class="btn btn-secondary">
            <i class="bi bi-arrow-counterclockwise"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©
          </button>
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <div class="alert alert-danger text-center">
    âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„ÙˆØ³ÙŠØ· Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­.
  </div>
  {% endif %}
</div>

<script>
document.getElementById("cartons_requested").addEventListener("input", function() {
  let pricePerCarton = {{ order.price_per_carton }};
  let cartonsRequested = parseInt(this.value);
  if (isNaN(cartonsRequested) || cartonsRequested < {{ order.min_contribution }}) {
    cartonsRequested = {{ order.min_contribution }};
    this.value = cartonsRequested;
  }
  let totalAmount = pricePerCarton * cartonsRequested;
  document.getElementById("final_payment_amount").textContent = totalAmount.toFixed(2);
  document.getElementById("cartons_requested_display").textContent = cartonsRequested;
});
</script>
{% endblock %}
