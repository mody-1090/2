{% extends "base.html" %}

{% block title %}๐ฆ ุชุณุฌูู ุทูุจูุฉ ุฌุฏูุฏุฉ{% endblock %}

{% block content %}
<div class="container p-4">

  <!-- ุนููุงู ุงูุตูุญุฉ -->
  <div class="row mb-4">
    <div class="col text-center">
      <h2 class="display-4">
        <i class="bi bi-person-plus"></i> ุชุณุฌูู ุทูุจูุฉ ุฌุฏูุฏุฉ
      </h2>
      <p class="lead text-muted">ูุฑุฌู ุฅุฏุฎุงู ูุนูููุงุช ูุชุฌุฑู ูุฅุชูุงู ุงูุฏูุน ููููุฑุฏ ูุชุณุฌูู ุงูุทูุจูุฉ.</p>
    </div>
  </div>

  {% if order %}
  <!-- ูููุฐุฌ ุชุณุฌูู ุงูุทูุจ -->
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="bi bi-pencil-square"></i> ูููุฐุฌ ุงูุชุณุฌูู</h4>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('main_routes.customer_registration', intermediary_id=intermediary.id, order_id=order.id) }}" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <!-- ุจูุงูุงุช ุงูุทูุจ -->
        <div class="mb-3">
          <label class="form-label">๐ท๏ธ ุงูุทูุจูุฉ</label>
          <input type="text" class="form-control" value="{{ order.name }} ({{ order.quantity_needed }} ูุฑุชููุฉ ูุชุงุญุฉ)" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label">๐ช ุงุณู ุงููุชุฌุฑ ุฃู ุงูุนููู</label>
          <input type="text" class="form-control" name="store_name" placeholder="ุฃุฏุฎู ุงุณู ุงููุชุฌุฑ ุฃู ุงูุนููู" required>
        </div>

        <div class="mb-3">
          <label class="form-label">๐ฆ ุนุฏุฏ ุงููุฑุงุชูู ุงููุทููุจุฉ</label>
          <input type="number" class="form-control" name="cartons_requested" id="cartons_requested" placeholder="ุฃุฏุฎู ุนุฏุฏ ุงููุฑุงุชูู" min="{{ order.min_contribution }}" required>
          <small class="text-muted">ุงูุญุฏ ุงูุฃุฏูู ููุทูุจ: {{ order.min_contribution }} ูุฑุชูู</small>
        </div>

        <div class="mb-3">
          <label class="form-label">๐ ูููุน ุงูุนููู</label>
          <input type="text" class="form-control" name="location" placeholder="ุฃุฏุฎู ูููุน ุงูุนููู" required>
        </div>

        <div class="mb-3">
          <label class="form-label">๐ค ุงุณู ุงููุณุคูู ูู ุงููุชุฌุฑ</label>
          <input type="text" class="form-control" name="responsible_person" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุคูู" required>
        </div>

        <div class="mb-3">
          <label class="form-label">๐ฑ ุฑูู ุฌูุงู ุงูุนููู</label>
          <input type="text" class="form-control" name="customer_phone" placeholder="ุฃุฏุฎู ุฑูู ุฌูุงู ุงูุนููู" required>
        </div>

        <div class="mb-3">
          <label class="form-label">๐ข ุงูุฑูู ุงูุถุฑูุจู</label>
          <input type="text" class="form-control" name="tax_number" placeholder="ุฃุฏุฎู ุงูุฑูู ุงูุถุฑูุจู" required>
        </div>

        <div class="mb-3">
          <label class="form-label">๐ ุตูุฑุฉ ุงูุณุฌู ุงูุชุฌุงุฑู</label>
          <input type="file" class="form-control" name="commercial_record" required>
        </div>

        <div class="mb-3">
          <label class="form-label">๐ช ุตูุฑุฉ ููุญุฉ ุงููุญู</label>
          <input type="file" class="form-control" name="store_sign" required>
        </div>

        <!-- ุชูุงุตูู ุงูุฏูุน -->
        <h5>๐ต ุชูุงุตูู ุงูุฏูุน</h5>
        <p><strong>๐ฆ ุงูููุชุฌ:</strong> {{ order.name }}</p>
        <p><strong>๐ฆ ุนุฏุฏ ุงููุฑุงุชูู ุงููุทููุจุฉ:</strong> <span id="cartons_requested_display">{{ order.min_contribution }}</span></p>
        <p><strong>๐ฐ ุณุนุฑ ุงููุฑุชูู ุงููุงุญุฏ (ุดุงูู ุงูุถุฑูุจุฉ):</strong> {{ order.price_per_carton }} ุฑูุงู</p>

        {% set total_amount = order.price_per_carton * order.min_contribution %}
        <h5 class="text-danger"><strong>๐ฐ ุงููุจูุบ ุงูููุงุฆู ุงููุทููุจ ุชุญูููู:</strong> <span id="final_payment_amount">{{ total_amount|round(2) }}</span> ุฑูุงู</h5>

        <div class="alert alert-info mt-3">
          ๐ <strong>ููุงุญุธุฉ:</strong> ูุฐุง ูู **ุงููุจูุบ ุงูุฅุฌูุงูู ุงููุทููุจ ุชุญูููู** ุฅูู ุงูููุฑุฏ. ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุญููู ุงููุจูุบ ุจุงููุงูู ูุถูุงู ุชุฃููุฏ ุทูุจู.
        </div>

        <!-- ุชูุงุตูู ุงูุญุณุงุจ ุงูุจููู ููููุฑุฏ -->
        <div class="card mb-3 p-3 border">
          <h5>๐ฆ ุชูุงุตูู ุงูุญุณุงุจ ุงูุจููู ููููุฑุฏ</h5>
          <p><strong>๐ฆ ุงุณู ุงูุจูู:</strong> {{ order.factory_agreement.bank_name if order.factory_agreement else '--' }}</p>
          <p><strong>๐ณ ุฑูู ุงูุญุณุงุจ:</strong> {{ order.factory_agreement.bank_account_number if order.factory_agreement else '--' }}</p>
          <p><strong>๐ข ุฑูู ุงูุขูุจุงู:</strong> {{ order.factory_agreement.iban_number if order.factory_agreement else '--' }}</p>
          <div class="mb-3">
            <label class="form-label">๐ค ุฑูุน ุฅูุตุงู ุงูุฏูุน</label>
            <input type="file" class="form-control" name="payment_receipt" required>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2">
          <button type="reset" class="btn btn-secondary">
            <i class="bi bi-arrow-counterclockwise"></i> ุฅุนุงุฏุฉ ุชุนููู
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle"></i> ุชุณุฌูู ุงูุทูุจูุฉ
          </button>
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <div class="alert alert-danger text-center">
    โ ูุง ุชูุฌุฏ ุทูุจูุฉ ูุณุฌูุฉ ููุฐุง ุงูุฑุงุจุทุ ูุฑุฌู ุงูุชูุงุตู ูุน ุงููุณูุท ููุญุตูู ุนูู ุฑุงุจุท ุตุญูุญ.
  </div>
  {% endif %}
</div>

<script>
document.getElementById("cartons_requested").addEventListener("input", function() {
  let pricePerCarton = {{ order.price_per_carton }};
  let cartonsRequested = parseInt(this.value);
  if (isNaN(cartonsRequested) || cartonsRequested < {{ order.min_contribution }}) {
    cartonsRequested = {{ order.min_contribution }};
    this.value = cartonsRequested;
  }
  let totalAmount = pricePerCarton * cartonsRequested;
  document.getElementById("final_payment_amount").textContent = totalAmount.toFixed(2);
  document.getElementById("cartons_requested_display").textContent = cartonsRequested;
});
</script>
{% endblock %}
